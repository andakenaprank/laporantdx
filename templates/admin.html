<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .table-container {
      width: 100%;
      overflow-x: auto;
      margin-top: 15px;
    }
    .table-box {
      margin: 20px auto;
      padding: 10px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      overflow: auto;
      width: 95vw;
      max-height: 80vh;
      text-align: center;
    }
    .table-box table {
      border-collapse: collapse;
      font-size: 11px;
      width: 100%;
      table-layout: auto;
    }
    .table-box th, .table-box td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      white-space: nowrap;
      text-align: left;
    }
    .table-box th {
      background: #f5f5f5;
      top: 0;
    }
    .table-box tr:nth-child(even) { background: #fafafa; }

    .table-container table {
      border-collapse: collapse;
      min-width: 100%;
      font-size: 12px;
    }
    .table-container th, .table-container td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
      white-space: nowrap;
    }
    .table-container th { background: #f5f5f5; top: 0; }

    /* Sidebar */
    .sidebar {
      height: 100%;
      width: 250px;
      position: fixed;
      top: 0;
      left: -250px; /* tertutup */
      background: #333;
      color: #fff;
      transition: 0.3s;
      padding-top: 60px;
      z-index: 999;
    }
    .sidebar.open { left: 0; }
    .sidebar a {
      display: block;
      padding: 12px;
      color: white;
      text-decoration: none;
    }
    .sidebar a:hover { background: #575757; }

    /* Burger button */
    .burger {
      width: auto !important;
      height: auto;
      font-size: 22px;
      cursor: pointer;
      background: #111;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }

    /* Main content */
    #main {
      margin-left: 0;
      transition: margin-left 0.3s;
      padding: 20px;
    }
    #main.shift { margin-left: 250px; }

    /* ===== Card untuk daftar petugas ===== */
    .petugas-section {
      display: flex;
      flex-direction: row;
      gap: 20px;
      margin-top: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .petugas-card {
      flex: 0 0 250px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .petugas-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    .petugas-card h4 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 18px;
      color: #007bff;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
    .petugas-card ul { list-style: none; padding-left: 0; margin: 0; }
    .petugas-card li {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .petugas-card li:last-child { border-bottom: none; }
    .petugas-card li::before { content: "üë§"; margin-right: 8px; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <a href="#" onclick="showLaporan()">üìÑ Lihat Laporan</a>
    <a href="#" onclick="showPetugas()">üë• Nama Petugas</a>
    <a href="{{ url_for('logout') }}">üö™ Logout</a>
  </div>

  <!-- Burger button -->
  <button class="burger" onclick="toggleSidebar()">‚ò∞</button>

  <!-- Content -->
  <div id="main">
    <h2>Admin Dashboard</h2>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
  <label for="filter-waktu"><strong>Filter Waktu:</strong></label>
  <select id="filter-waktu">
    <option value="">Semua</option>
    <option value="pagi">Pagi</option>
    <option value="sore">Sore</option>
  </select>
  <button id="btn-apply-filter">Terapkan</button>
</div>

    <div id="content"></div>
  </div>

  <script>
    async function loadLaporan(waktu = "") {
  const p = new URLSearchParams();
  if (waktu) p.set("waktu", waktu); // 'pagi' | 'sore'
  const url = "/admin_api/laporan" + (p.toString() ? `?${p.toString()}` : "");

  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) {
    console.error("Gagal memuat laporan:", res.status);
    return;
  }
  const payload = await res.json();
  const items = payload.items || [];

  const tbody = document.querySelector("#tbl-laporan tbody");
  if (!tbody) return;

  tbody.innerHTML = items.map(row => `
    <tr>
      <td>${row.id}</td>
      <td>${row.tanggal || ""}</td>
      <td>${row.nama_td || ""}</td>
      <td>${row.nama_pdu || ""}</td>
      <td>${row.nama_tx || ""}</td>
      <td>${row.acara_15 || ""}</td>
      <td>${row.format_15 || ""}</td>
      <td>${row.acara_16 || ""}</td>
      <td>${row.format_16 || ""}</td>
      <td>${row.acara_17 || ""}</td>
      <td>${row.format_17 || ""}</td>
      <td>${row.acara_18 || ""}</td>
      <td>${row.format_18 || ""}</td>
      <td>${row.timestamp_wib || ""}</td>
    </tr>
  `).join("");
}

document.getElementById("btn-apply-filter").addEventListener("click", () => {
  const waktu = document.getElementById("filter-waktu").value;
  loadLaporan(waktu);
});

// load awal (tanpa filter)
loadLaporan();

    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const main = document.getElementById("main");
      sidebar.classList.toggle("open");
      main.classList.toggle("shift");
    }

    // ===== Helper =====
    function esc(s){
      return String(s ?? "").replace(/[&<>"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));
    }
    function linkify(url){
      if(!url) return "";
      const u = esc(url);
      return `<a href="${u}" target="_blank" rel="noopener">${u}</a>`;
    }

    // ===== Lihat laporan (dengan kolom Timestamp (WIB) di kiri) =====
    async function showLaporan(){
      const res = await fetch("/api/laporan");
      if(!res.ok){
        document.getElementById("content").innerHTML = "<p>Gagal memuat data laporan</p>";
        return;
      }
      const data = await res.json();
      if(!data.length){
        document.getElementById("content").innerHTML = "<p>Tidak ada laporan</p>";
        return;
      }

      // Susunan kolom: tambahkan timestamp_wib di paling kiri. Kolom lain tetap.
      const cols = [
          // ‚¨ÖÔ∏è kolom baru di kiri (hanya tampilan)
        "id","timestamp_wib", "tanggal", "nama_td", "nama_pdu", "nama_tx",
        "studio_link", "streaming_link", "subcontrol_link",
        "acara_15", "format_15", "acara_16", "format_16",
        "acara_17", "format_17", "acara_18", "format_18",
        "kendala", "waktu_kendala", "link_kendala", "kesimpulan"
      ];

      let html = "<h3>Daftar Laporan</h3>";
      html += "<div class='table-box'><table>";
      html += "<tr>" + cols.map(c => `<th>${esc(c.replace('_',' ').toUpperCase())}</th>`).join("") + "</tr>";
      
      data.forEach(r => {
        const tds = cols.map(c => {
          if(["studio_link","streaming_link","subcontrol_link"].includes(c)){
            return `<td>${linkify(r[c])}</td>`;
          }
          if(c === "link_kendala"){
            const parts = String(r[c] ?? "").split(",").map(s => s.trim()).filter(Boolean);
            return `<td>${parts.map(p => linkify(p)).join("<br/>")}</td>`;
          }
          return `<td>${esc(r[c])}</td>`;
        }).join("");
        html += `<tr>${tds}</tr>`;
      });

      html += "</table></div>";
      document.getElementById("content").innerHTML = html;
    }

    // ===== Daftar petugas =====
    
  async function showPetugas() {
    const container = document.getElementById("content");
    try {
      // Hindari cache
      const res = await fetch(`/api/petugas?_=${Date.now()}`, {
        headers: { "Accept": "application/json" },
        cache: "no-store",
      });

      if (!res.ok) {
        const text = await res.text();
        container.innerHTML = `
          <p>‚ùå Gagal memuat daftar petugas (HTTP ${res.status}).</p>
          <pre style="white-space:pre-wrap;background:#fff3f3;border:1px solid #f5c2c7;padding:8px;border-radius:6px;max-height:200px;overflow:auto;">
${esc(text.slice(0,500))}
          </pre>`;
        return;
      }

      const ctype = res.headers.get("content-type") || "";
      if (!ctype.includes("application/json")) {
        const text = await res.text();
        container.innerHTML = `
          <p>‚ùå Server membalas non-JSON untuk /api/petugas.</p>
          <pre style="white-space:pre-wrap;background:#fff3f3;border:1px solid #f5c2c7;padding:8px;border-radius:6px;max-height:200px;overflow:auto;">
${esc(text.slice(0,500))}
          </pre>`;
        return;
      }

      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = "<p>Belum ada petugas</p>";
        return;
      }

      // --- Normalisasi, kelompokkan, sort, dedup ---
      const grouped = {};
      for (const p of data) {
        const jenis = String(p.jenis ?? "").trim().toUpperCase() || "LAINNYA";
        const nama  = String(p.nama ?? "").trim();
        if (!nama) continue;
        if (!grouped[jenis]) grouped[jenis] = new Set();
        grouped[jenis].add(nama);
      }

      // Urutkan jenis dan nama
      const jenisList = Object.keys(grouped).sort();
      let html = "<h3>Daftar Petugas</h3><div class='petugas-section'>";
      for (const jenis of jenisList) {
        const names = Array.from(grouped[jenis]).sort((a,b)=>a.localeCompare(b,'id'));
        html += `
          <div class="petugas-card">
            <h4>${esc(jenis)}</h4>
            <ul>
              ${names.map(n => `<li>${esc(n)}</li>`).join("")}
            </ul>
          </div>
        `;
      }
      html += "</div>";
      container.innerHTML = html;

    } catch (err) {
      container.innerHTML = `<p>‚ùå Gagal ambil data petugas: ${esc(err.message)}</p>`;
    }
  }
   window.onload = showLaporan;
  </script>
</body>
</html>
